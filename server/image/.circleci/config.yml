# Config dedicated for Server-image microservice
# All the resources must be prefixed with `image-` to avoid conflicts

version: 2.1

orbs:
  # Note: We are using the latest version of hello-build, whereas module B uses an older one
  image-hello-build: circleci/hello-build@0.0.14

jobs:
  image-build:
    docker:
      - image: alpine
    steps:
      - common-say-hello:
          to: A
      - run: echo 'Hello world from image server! :3'

workflows:
  image-workflow:
    jobs:
      - common-pre
      - image-build:
          requires:
            - common-pre
      - image-hello-build/hello-build:
          requires:
            - common-pre
      - test-and-build/build-and-publish-docker-image:
          requires:
            - image-hello-build/hello-build
          context:
            - image
            - docker_registry
      - kubernetes/update-deployment-image:
          requires:
            - 'test-and-build/build-and-publish-docker-image'
          context:
            - image
            - kubernetes
          container-image-updates: 'gras-server-image=grasadmin/server-image:$CIRCLE_SHA1'
          dry-run: ''
          namespace: default
          get-rollout-status: true
          watch-rollout-status: true
          watch-timeout: 30s
          pinned-revision-to-watch: ''
          resource-file-path: ''
          resource-name: deployment/gras-server-image
          show-kubectl-command: true
