# Config for the setup workflow and common resources (jobs, commands) for main workflows
# `common-` prefix is added for common resources (to avoid conflicts with module resources)
version: 2.1
setup: << pipeline.parameters.run-setup >>


# All pipeline parameters need to be defined equally both for the setup workflow and main workflows
# These parameters will be passed to both of them
parameters:
  run-setup:
    description: Whether it is a setup workflow or a continuation
    type: boolean
    default: true
  force-all:
    description: Emergency valve - forcibly build all the modules
    type: boolean
    default: false
  custom-parameter:
    description: Some string to pass
    type: string
    default: ''


# reference to attach 
references:
  workspace_root: &workspace_root
    /tmp/workspace
  attach_workspace: &attach_workspace
    attach_workspace:
      at: *workspace_root
  digest: &digest
    /tmp/digest
  attach_digest: &attach_digest
    attach_digest:
      at: *digest


workflows:
  # The setup workflow
  setup-workflow:
    when: << pipeline.parameters.run-setup >>
    jobs:
      # - test-and-build/run-tests:
      #     context: yarn
      - config-splitting/setup-dynamic-config:
          force-all: << pipeline.parameters.force-all >>
          base-revision: master
          # If A is modified, the job for A will run
          # Similarly if B is modified, the job for B will run
          # If C is modified, then the jobs for both C and B (as a dependency) will run
          modules: |
            apps/shop/
            apps/dashboard/
            apps/delivery-widget/
            server/main/
            server/location/
            server/payments/
            server/image/
            server/dispatch/
            # k8s/ # kubernetes files are not included, because i dont know where to put the config.yml file at the moment, or how to declare an alternate file path
            # packages # packages are rebuilt in the module build, for now
          # requires:
          #   - test-and-build/run-tests
      

orbs:
  # An "embedded" orb to facilitate config splitting
  config-splitting:
    # Dependencies
    orbs:
      continuation: circleci/continuation@0.1.2
    # Commands for the setup workflow
    commands:
      list-changed-modules:
        parameters:
          modules:
            description: |
              Directories which should be built upon changes.
              Each row represents a space-separated list of the root directories for modules, each of which must has own `.circleci/config.yml`.
              The first item of the list will be tested for changes, and will be added to the filtered list of modules if there are any changes.
              The subsequent items, if there are any, will also be added to the filtered list of modules if there are any changes in the directory specified as the first item.

              CAVEAT: Directory names having white spaces cannot be specified.
            type: string
          modules-filtered:
            description: Path to the file where the filtered list of modules is generated
            type: string
            default: /tmp/modules-filtered.txt
          base-revision:
            description: Revision to compare with the current HEAD
            type: string
            default: master
          force-all:
            description: Emergency valve - forcibly build all the modules
            type: boolean
            default: false
        steps:
          - run:
              name: Generate the list of modules having changes
              command: |
                # Add each module to `modules-filtered` if 1) `force-all` is set to `true`, 2) there is a diff against `base-revision`, 3) there is no `HEAD~1` (i.e., this is the very first commit for the repo) OR 4) there is a diff against the previous commit
                cat \<< EOD | sed -e '/^$/d' | while read row; do module="$(echo "$row" | awk '{ print $1 }')"; if [ << parameters.force-all >> == 'true' ] || [ $(git diff --name-only << parameters.base-revision >> "$module" | wc -l) -gt 0 ] || (! git rev-parse --verify HEAD~1) || [ $(git diff --name-only HEAD~1 "$module" | wc -l) -gt 0 ]; then echo "$row" | sed -e 's/ /\n/g' >> << parameters.modules-filtered >>; fi; done
                << parameters.modules >>
                EOD
      merge-modular-configs:
        parameters:
          modules:
            description: Path to the file for the list of the modules to build
            type: string
            default: /tmp/modules-filtered.txt
          shared-config:
            description: Path to the config providing shared resources (such as prerequisite jobs and common commands)
            type: string
            default: .circleci/config.yml
          continue-config:
            description: Path to the internally-used config for continuation
            type: string
            default: .circleci/continue-config.yml
        steps:
          - run:
              name: Merge configs
              command: |
                # If `modules` is unavailable, stop this job without continuation
                if [ ! -f "<< parameters.modules >>" ] || [ ! -s "<< parameters.modules >>" ]
                then
                  echo 'Nothing to merge. Halting the job.'
                  circleci-agent step halt
                  exit
                fi

                # Convert a list of dirs to a list of config.yml
                sed -i -e 's/$/\/.circleci\/config.yml/g' "<< parameters.modules >>"

                # If `shared-config` exists, append it at the end of `modules`
                if [ -f << parameters.shared-config >> ]
                then
                  echo "<< parameters.shared-config >>" >> "<< parameters.modules >>"
                fi

                xargs -a "<< parameters.modules >>" yq -y -s 'reduce .[] as $item ({}; . * $item)' | tee "<< parameters.continue-config >>"
    jobs:
      # The job for the setup workflow
      setup-dynamic-config:
        parameters:
          modules:
            description: Directories which should be tested for changes; one directory per line. Each directory must have `.circleci/config.yml`.
            type: string
          base-revision:
            description: Revision to compare with the current HEAD
            type: string
            default: master
          force-all:
            description: Emergency valve - forcibly build all the modules
            type: boolean
            default: false
          modules-filtered:
            description: Path to the file where the filtered list of modules is generated
            type: string
            default: /tmp/modules-filtered.txt
          shared-config:
            description: Path to the config providing shared resources (such as prerequisite jobs and common commands)
            type: string
            default: .circleci/config.yml
          continue-config:
            description: Path to the internally-used config for continuation
            type: string
            default: .circleci/continue-config.yml
        docker:
          - image: cimg/python:3.9
        steps:
          - checkout
          - run:
              name: Install yq
              command: pip install yq
          - list-changed-modules:
              modules: << parameters.modules >>
              modules-filtered: << parameters.modules-filtered >>
              base-revision: << parameters.base-revision >>
              force-all: << parameters.force-all >>
          - merge-modular-configs:
              modules: << parameters.modules-filtered >>
              shared-config: << parameters.shared-config >>
              continue-config: << parameters.continue-config >>
          - continuation/continue:
              configuration_path: << parameters.continue-config >>
              parameters: '{"run-setup":false}'
  test-and-build:
    orbs:
      docker: circleci/docker@2.2.0
    jobs:
      run-tests:
        docker:
          - image: cimg/node:16.20.0
        environment:
          JEST_JUNIT_OUTPUT_DIR: ./test-results/
        steps:
          - checkout
          - run:
              name: Print Yarn Version
              command: echo upgrading yarn to $CONTEXT_YARN_VERSION
          - run:
              name: Upgrade Yarn
              command: yarn set version $YARN_VERSION
          - run:
              name: Install Dependencies, Frozen Lockfile
              command: yarn install --frozen-lockfile
          - run:
              name: Run Unit Tests
              command: yarn g:test-unit-ci
          - store_test_results:
              path: ./test-results/
      build-and-publish-docker-image:
        executor: docker/machine
        # parallelism: 2 # parall builds for multiple modules
        environment:
          DOCKER_LOGIN: $DOCKER_USERNAME
          DOCKER_PASSWORD: $DOCKER_PASSWORD
        steps:
          - checkout
          - docker/check:
              # add credentials store to workflow workspace
              use-docker-credentials-store: true
          - docker/build: 
              dockerfile: Dockerfile.$BUILD_TYPE
              image: $DOCKER_USERNAME/$BUILD_CONTEXT
              path: '.'
              extra_build_args: '--build-arg=BUILD_CONTEXT=$BUILD_CONTEXT --build-arg=PORT=$PORT --no-cache --progress=plain'
          - docker/push:
              digest-path: /tmp/digest.txt
              image: $DOCKER_USERNAME/$BUILD_CONTEXT
          - run:
              command: |
                echo "Digest is: $(</tmp/digest.txt)"
          - persist_to_workspace:
              root: *workspace_root
              paths: 
                - digest.txt
  kubernetes:
    orbs: 
      kubernetes: circleci/kubernetes@1.3.1
    jobs: 
      update-deployment-image:
        executor: kubernetes/default
        parameters:
          container-image-updates: 
            description: "Specify a list of container image updates (space-delimited name value pairs in the form CONTAINER_NAME_1=CONTAINER_IMAGE_1 ... CONTAINER_NAME_N=CONTAINER_IMAGE_N) to be applied to the resource via `kubectl set image`"
            type: string
          dry-run: 
            description: Whether the kubectl command will be executed in dry-run mode.
            type: string
            default: ''
          namespace: 
            description: The kubernetes namespace
            type: string
            default: default
          get-rollout-status: 
            description: Get the status of the rollout. This can only be used for resource types that are valid for usage with `kubectl rollout` subcommands.
            type: boolean
            default: false
          watch-rollout-status: 
            description: Whether to watch the status of the latest rollout until it's done. Only effective if get-rollout-status is set to true.
            type: boolean
            default: true
          watch-timeout: 
            description: The length of time to wait before ending the watch, zero means never. Any other values should contain a corresponding time unit (e.g. 1s, 2m, 3h). Only effective if get-rollout-status is set to true.
            type: string
            default: ''
          pinned-revision-to-watch: 
            description: Pin a specific revision to be watched and abort watching if it is rolled over by another revision. Only effective if get-rollout-status is set to true.
            type: string
            default: ''
          resource-file-path: 
            description: Path to file used to update the resource. Either resource-file-path or resource-name need to be specified.
            type: string
            default: ''
          resource-name: 
            description: Resource name in the format TYPE/NAME e.g. deployment/nginx-deployment Either resource-file-path or resource-name need to be specified. This is required if get-rollout-status is set to true.
            type: string
            default: ''
          show-kubectl-command: 
            description: Whether to show the kubectl command used.
            type: boolean
            default: false
        steps:
          - *attach_workspace
          - run: 
              name: "Print New Image"
              command: "Update image: gras-shop=grasadmin/shop:$(</tmp/digest.txt)"
          - kubernetes/update-container-image:
              container-image-updates: "gras-shop=grasadmin/shop:$(</tmp/digest.txt)"
              dry-run: << parameters.dry-run >>
              namespace: << parameters.namespace >>
              get-rollout-status: << parameters.get-rollout-status >>
              watch-rollout-status: << parameters.watch-rollout-status >>
              watch-timeout: << parameters.watch-timeout >>
              pinned-revision-to-watch: << parameters.pinned-revision-to-watch >>
              resource-file-path: << parameters.resource-file-path >>
              resource-name: << parameters.resource-name >>
              show-kubectl-command: << parameters.show-kubectl-command >>


# Custom commands aimed for the main workflows and jobs
commands:
  common-say-hello:
    parameters:
      to:
        description: To whom you say hello
        type: string
        default: you anonymous
    steps:
      - run: echo 'Greetings to << parameters.to >> from the shared command!'
      - run: echo 'The value of `custom-parameter` was "<< pipeline.parameters.custom-parameter >>"'


# Common jobs for the main workflows
jobs:
  common-pre:
    docker:
      - image: alpine
    steps:
      - common-say-hello
      - run: echo 'Jobs with `common-` prefix are intended to be shared among modules'