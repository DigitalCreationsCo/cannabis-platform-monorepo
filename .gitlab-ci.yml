---
include:
  - .gitlab/ci/cache.gitlab-ci.yml
  - .gitlab/ci/module.gitlab-ci.yml
  # - .gitlab/ci/deploy.gitlab-ci.yml

.modules:
  - MODULE:
      - app/shop
      # - app/dashboard
      # - app/checkout-widget
      # - server/main
      # - server/location
      # - server/payments
      # - server/image
      # - supertokens

stages:
  # - cache
  - build
  # - tag # Future TODO: Add Semantic Versioning to Images
  # https://github.com/semantic-release/semantic-release

  # - release
  # - deploy

# cache:
#   extends: .yarn-cache
# add cache rules

build:
  extends: .module_build
  parallel:
    matrix: !reference [.modules]
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
      changes:
        - node_modules
        - ${MODULE}/**/*

tag:
  extends: .module_tag_version
  parallel:
    matrix: !reference [.modules]
  rules:
    # Default branch
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
      changes:
        - node_modules
        - ${MODULE}/**/*

publish:
  extends: .module_publish
  parallel:
    matrix: !reference [.modules]
  rules:
    # Tags
    # - if: $CI_COMMIT_TAG =~ /^$IMAGE-v[0-9]+\.[0-9]+\.[0-9]+$/
    - if: $CI_COMMIT_TAG =~ /.+-v[0-9]+\.[0-9]+\.[0-9]+$/

deploy:
  extends: .module_deploy
  parallel:
    matrix: !reference [.modules]
  rules:
    # is production branch
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
      changes:
        - node_modules
        - ${MODULE}/**/*
# ========================================
# optimized CI for module builds
# such as each module job can run depending on changes of the module path, and the node_modules dependencies

# check this example for an idea: https://how-to.dev/how-to-set-up-monorepo-build-in-gitlab-ci

# TODO: Understand the parallel matrix: https://docs.gitlab.com/ee/ci/yaml/#parallelmatrix
# Run a one-dimensional matrix of parallel jobs:
# https://docs.gitlab.com/ee/ci/jobs/job_control.html#run-a-one-dimensional-matrix-of-parallel-jobs

# Run a matrix of parallel trigger jobs
# https://docs.gitlab.com/ee/ci/jobs/job_control.html#run-a-matrix-of-parallel-trigger-jobs

# Select different runner tags for each parallel matrix job
# https://docs.gitlab.com/ee/ci/jobs/job_control.html#select-different-runner-tags-for-each-parallel-matrix-job
